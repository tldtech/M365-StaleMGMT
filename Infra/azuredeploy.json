{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "2.0.1.0",
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Azure region for all resources."
            }
        },
        "namePrefix": {
            "type": "string",
            "defaultValue": "stalesweep",
            "minLength": 3,
            "maxLength": 15,
            "metadata": {
                "description": "Short prefix used to generate unique resource names."
            }
        },
        "powerShellVersion": {
            "type": "string",
            "defaultValue": "7.4",
            "allowedValues": [
                "7.2",
                "7.4"
            ],
            "metadata": {
                "description": "PowerShell runtime version for Linux Functions."
            }
        },
        "mode": {
            "type": "string",
            "defaultValue": "detect",
            "allowedValues": [
                "report",
                "detect",
                "disable",
                "tag",
                "decide",
                "execute"
            ],
            "metadata": {
                "description": "MODE."
            }
        },
        "graphApiVersion": {
            "type": "string",
            "defaultValue": "v1.0",
            "allowedValues": [
                "v1.0",
                "beta"
            ],
            "metadata": {
                "description": "GRAPH_API_VERSION."
            }
        },
        "staleDays": {
            "type": "int",
            "defaultValue": 90,
            "minValue": 1,
            "metadata": {
                "description": "STALE_DAYS."
            }
        },
        "maxActions": {
            "type": "int",
            "defaultValue": 50,
            "minValue": 0,
            "metadata": {
                "description": "MAX_ACTIONS (global safety cap)."
            }
        },
        "confirmDisable": {
            "type": "string",
            "defaultValue": "false",
            "allowedValues": [
                "true",
                "false"
            ],
            "metadata": {
                "description": "CONFIRM_DISABLE."
            }
        },
        "confirmTag": {
            "type": "string",
            "defaultValue": "false",
            "allowedValues": [
                "true",
                "false"
            ],
            "metadata": {
                "description": "CONFIRM_TAG."
            }
        },
        "extensionName": {
            "type": "string",
            "defaultValue": "STALE",
            "metadata": {
                "description": "EXTENSION_NAME."
            }
        },
        "includeIntune": {
            "type": "string",
            "defaultValue": "false",
            "allowedValues": [
                "true",
                "false"
            ],
            "metadata": {
                "description": "INCLUDE_INTUNE."
            }
        },
        "activitySource": {
            "type": "string",
            "defaultValue": "signin",
            "allowedValues": [
                "signin",
                "intune",
                "mostrecent"
            ],
            "metadata": {
                "description": "ACTIVITY_SOURCE."
            }
        },
        "intuneStaleDays": {
            "type": "int",
            "defaultValue": 90,
            "minValue": 1,
            "metadata": {
                "description": "INTUNE_STALE_DAYS (defaults to STALE_DAYS in code if not set)."
            }
        },
        "requireBothStaleForDisable": {
            "type": "string",
            "defaultValue": "true",
            "allowedValues": [
                "true",
                "false"
            ],
            "metadata": {
                "description": "REQUIRE_BOTH_STALE_FOR_DISABLE."
            }
        },
        "dontDisableIfIntuneRecentSync": {
            "type": "string",
            "defaultValue": "true",
            "allowedValues": [
                "true",
                "false"
            ],
            "metadata": {
                "description": "DONT_DISABLE_IF_INTUNE_RECENT_SYNC."
            }
        },
        "intuneRecentSyncDays": {
            "type": "int",
            "defaultValue": 14,
            "minValue": 0,
            "metadata": {
                "description": "INTUNE_RECENT_SYNC_DAYS."
            }
        },
        "dontDisableIfCompliant": {
            "type": "string",
            "defaultValue": "true",
            "allowedValues": [
                "true",
                "false"
            ],
            "metadata": {
                "description": "DONT_DISABLE_IF_COMPLIANT."
            }
        },
        "allowDisableOnDuplicate": {
            "type": "string",
            "defaultValue": "false",
            "allowedValues": [
                "true",
                "false"
            ],
            "metadata": {
                "description": "ALLOW_DISABLE_ON_DUPLICATE."
            }
        },
        "onlyDisableIfManagedAgentIn": {
            "type": "string",
            "defaultValue": "mdm,easmdm",
            "metadata": {
                "description": "ONLY_DISABLE_IF_MANAGEDAGENT_IN (comma-separated). Empty disables the constraint."
            }
        },
        "confirmIntuneRetire": {
            "type": "string",
            "defaultValue": "false",
            "allowedValues": [
                "true",
                "false"
            ],
            "metadata": {
                "description": "CONFIRM_INTUNE_RETIRE."
            }
        },
        "confirmIntuneWipe": {
            "type": "string",
            "defaultValue": "false",
            "allowedValues": [
                "true",
                "false"
            ],
            "metadata": {
                "description": "CONFIRM_INTUNE_WIPE."
            }
        },
        "confirmIntuneDelete": {
            "type": "string",
            "defaultValue": "false",
            "allowedValues": [
                "true",
                "false"
            ],
            "metadata": {
                "description": "CONFIRM_INTUNE_DELETE."
            }
        },
        "maxDisable": {
            "type": "int",
            "defaultValue": 50,
            "minValue": 0,
            "metadata": {
                "description": "MAX_DISABLE."
            }
        },
        "maxTag": {
            "type": "int",
            "defaultValue": 50,
            "minValue": 0,
            "metadata": {
                "description": "MAX_TAG."
            }
        },
        "maxRetire": {
            "type": "int",
            "defaultValue": 25,
            "minValue": 0,
            "metadata": {
                "description": "MAX_RETIRE."
            }
        },
        "maxWipe": {
            "type": "int",
            "defaultValue": 5,
            "minValue": 0,
            "metadata": {
                "description": "MAX_WIPE."
            }
        },
        "maxIntuneDelete": {
            "type": "int",
            "defaultValue": 25,
            "minValue": 0,
            "metadata": {
                "description": "MAX_INTUNE_DELETE."
            }
        },
        "actionParallelism": {
            "type": "int",
            "defaultValue": 5,
            "minValue": 1,
            "maxValue": 50,
            "metadata": {
                "description": "ACTION_PARALLELISM."
            }
        },
        "exceptionGroupId": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "EXCEPTION_GROUP_ID (Entra group objectId). Leave blank to disable."
            }
        },
        "exceptionNamePatterns": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "EXCEPTION_NAME_PATTERNS (comma-separated wildcards). Leave blank to disable."
            }
        },
        "exceptionDeviceIds": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "EXCEPTION_DEVICE_IDS (comma-separated device objectIds). Leave blank to disable."
            }
        },
        "websiteRunFromPackage": {
            "type": "string",
            "defaultValue": "1",
            "allowedValues": [
                "1"
            ],
            "metadata": {
                "description": "WEBSITE_RUN_FROM_PACKAGE. Set to 1 for zip/package deployment."
            }
        },
        "logAnalyticsRetentionDays": {
            "type": "int",
            "defaultValue": 30,
            "minValue": 30,
            "maxValue": 730,
            "metadata": {
                "description": "Log Analytics retention days (30-730)."
            }
        }
    },
    "variables": {
        "planName": "[toLower(concat(parameters('namePrefix'), '-fc-', uniqueString(resourceGroup().id)))]",
        "functionAppName": "[toLower(concat(parameters('namePrefix'), '-func-', uniqueString(resourceGroup().id)))]",
        "storageAccountName": "[toLower(substring(concat(parameters('namePrefix'), uniqueString(resourceGroup().id, 'stg')), 0, 24))]",
        "logAnalyticsWorkspaceName": "[toLower(concat(parameters('namePrefix'), '-law-', uniqueString(resourceGroup().id)))]",
        "appInsightsName": "[toLower(concat(parameters('namePrefix'), '-ai-', uniqueString(resourceGroup().id)))]",
        "storageSku": "Standard_LRS"
    },
    "resources": [
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2023-01-01",
            "name": "[variables('storageAccountName')]",
            "location": "[parameters('location')]",
            "kind": "StorageV2",
            "sku": {
                "name": "[variables('storageSku')]"
            },
            "properties": {
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "allowBlobPublicAccess": false,
                "accessTier": "Hot"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces",
            "apiVersion": "2023-09-01",
            "name": "[variables('logAnalyticsWorkspaceName')]",
            "location": "[parameters('location')]",
            "properties": {
                "retentionInDays": "[parameters('logAnalyticsRetentionDays')]"
            },
            "sku": {
                "name": "PerGB2018"
            }
        },
        {
            "type": "Microsoft.Insights/components",
            "apiVersion": "2020-02-02",
            "name": "[variables('appInsightsName')]",
            "location": "[parameters('location')]",
            "kind": "web",
            "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
            ]
        },
        {
            "type": "Microsoft.Web/serverfarms",
            "apiVersion": "2023-01-01",
            "name": "[variables('planName')]",
            "location": "[parameters('location')]",
            "kind": "functionapp",
            "sku": {
                "name": "FC1",
                "tier": "FlexConsumption"
            },
            "properties": {
                "reserved": true
            }
        },
        {
            "type": "Microsoft.Web/sites",
            "apiVersion": "2023-01-01",
            "name": "[variables('functionAppName')]",
            "location": "[parameters('location')]",
            "kind": "functionapp,linux",
            "identity": {
                "type": "SystemAssigned"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('planName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
                "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
            ],
            "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('planName'))]",
                "httpsOnly": true,
                "siteConfig": {
                    "linuxFxVersion": "[concat('PowerShell|', parameters('powerShellVersion'))]",
                    "ftpsState": "Disabled",
                    "minTlsVersion": "1.2",
                    "appSettings": [
                        {
                            "name": "AzureWebJobsStorage",
                            "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01').keys[0].value, ';EndpointSuffix=', environment().suffixes.storage)]"
                        },
                        {
                            "name": "FUNCTIONS_EXTENSION_VERSION",
                            "value": "~4"
                        },
                        {
                            "name": "FUNCTIONS_WORKER_RUNTIME",
                            "value": "powershell"
                        },
                        {
                            "name": "WEBSITE_RUN_FROM_PACKAGE",
                            "value": "[parameters('websiteRunFromPackage')]"
                        },
                        {
                            "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                            "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').ConnectionString]"
                        },
                        {
                            "name": "STALE_DAYS",
                            "value": "[string(parameters('staleDays'))]"
                        },
                        {
                            "name": "MODE",
                            "value": "[parameters('mode')]"
                        },
                        {
                            "name": "GRAPH_API_VERSION",
                            "value": "[parameters('graphApiVersion')]"
                        },
                        {
                            "name": "MAX_ACTIONS",
                            "value": "[string(parameters('maxActions'))]"
                        },
                        {
                            "name": "CONFIRM_DISABLE",
                            "value": "[parameters('confirmDisable')]"
                        },
                        {
                            "name": "CONFIRM_TAG",
                            "value": "[parameters('confirmTag')]"
                        },
                        {
                            "name": "EXTENSION_NAME",
                            "value": "[parameters('extensionName')]"
                        },
                        {
                            "name": "INCLUDE_INTUNE",
                            "value": "[parameters('includeIntune')]"
                        },
                        {
                            "name": "ACTIVITY_SOURCE",
                            "value": "[parameters('activitySource')]"
                        },
                        {
                            "name": "INTUNE_STALE_DAYS",
                            "value": "[string(parameters('intuneStaleDays'))]"
                        },
                        {
                            "name": "REQUIRE_BOTH_STALE_FOR_DISABLE",
                            "value": "[parameters('requireBothStaleForDisable')]"
                        },
                        {
                            "name": "DONT_DISABLE_IF_INTUNE_RECENT_SYNC",
                            "value": "[parameters('dontDisableIfIntuneRecentSync')]"
                        },
                        {
                            "name": "INTUNE_RECENT_SYNC_DAYS",
                            "value": "[string(parameters('intuneRecentSyncDays'))]"
                        },
                        {
                            "name": "DONT_DISABLE_IF_COMPLIANT",
                            "value": "[parameters('dontDisableIfCompliant')]"
                        },
                        {
                            "name": "ALLOW_DISABLE_ON_DUPLICATE",
                            "value": "[parameters('allowDisableOnDuplicate')]"
                        },
                        {
                            "name": "ONLY_DISABLE_IF_MANAGEDAGENT_IN",
                            "value": "[parameters('onlyDisableIfManagedAgentIn')]"
                        },
                        {
                            "name": "CONFIRM_INTUNE_RETIRE",
                            "value": "[parameters('confirmIntuneRetire')]"
                        },
                        {
                            "name": "CONFIRM_INTUNE_WIPE",
                            "value": "[parameters('confirmIntuneWipe')]"
                        },
                        {
                            "name": "CONFIRM_INTUNE_DELETE",
                            "value": "[parameters('confirmIntuneDelete')]"
                        },
                        {
                            "name": "MAX_DISABLE",
                            "value": "[string(parameters('maxDisable'))]"
                        },
                        {
                            "name": "MAX_TAG",
                            "value": "[string(parameters('maxTag'))]"
                        },
                        {
                            "name": "MAX_RETIRE",
                            "value": "[string(parameters('maxRetire'))]"
                        },
                        {
                            "name": "MAX_WIPE",
                            "value": "[string(parameters('maxWipe'))]"
                        },
                        {
                            "name": "MAX_INTUNE_DELETE",
                            "value": "[string(parameters('maxIntuneDelete'))]"
                        },
                        {
                            "name": "ACTION_PARALLELISM",
                            "value": "[string(parameters('actionParallelism'))]"
                        },
                        {
                            "name": "EXCEPTION_GROUP_ID",
                            "value": "[parameters('exceptionGroupId')]"
                        },
                        {
                            "name": "EXCEPTION_NAME_PATTERNS",
                            "value": "[parameters('exceptionNamePatterns')]"
                        },
                        {
                            "name": "EXCEPTION_DEVICE_IDS",
                            "value": "[parameters('exceptionDeviceIds')]"
                        }
                    ]
                }
            }
        }
    ],
    "outputs": {
        "functionAppName": {
            "type": "string",
            "value": "[variables('functionAppName')]"
        },
        "functionAppHostname": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2023-01-01').defaultHostName]"
        },
        "functionAppPrincipalId": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2023-01-01', 'Full').identity.principalId]"
        },
        "storageAccountName": {
            "type": "string",
            "value": "[variables('storageAccountName')]"
        },
        "appInsightsName": {
            "type": "string",
            "value": "[variables('appInsightsName')]"
        },
        "logAnalyticsWorkspaceName": {
            "type": "string",
            "value": "[variables('logAnalyticsWorkspaceName')]"
        },
        "planName": {
            "type": "string",
            "value": "[variables('planName')]"
        }
    }
}